<p>断点续传其实不是什么新鲜的功能了。<br>
简单的做个扫盲，其基本原理就是，在文件的下载断开以后。客户端继续向服务器端请求的时候，http请求的头文件中会多了一个参数“Range”，来标示当前下载的文件所断开的位置。<br>
用如下命令可以做个测试<br>
wget -c -d –limit-rate=2048k -O target “<a href="http://127.0.0.1:8000%E2%80%B3%EF%BC%88ps">http://127.0.0.1:8000″（ps</a>. c表示让wget进行断点续传，如果不加c发送请求的头文件中是不会，d标示打印调试信息）<br><img src="http://ww4.sinaimg.cn/mw1024/6bf9eebbjw1ea0zp8pcbxj20hr0dygo5.jpg" alt="截图" style="max-width:100%;"><br>
接下来的下载，就是从这个断开的位置开始，服务器继续向客户端传输文件剩余的内容了。</p>

<p>主要的是关注两个地方，一个就是返回头文件的设置，和文件内容的读取。<br>
新建一个叫Transfer的类，把请求的两个参数当成构造函数传进去。</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">Transfer</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">req</span> <span class="o">=</span> <span class="nx">req</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">resp</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>计算文件开始的位置和设置头文件的信息如下</p>

<div class="highlight highlight-javascript"><pre><span class="cm">/**</span>
<span class="cm"> * @description 计算上次的断点信息</span>
<span class="cm"> * @param {string} Range 请求http头文件中的断点信息，如果没有则为undefined，格式（range: bytes=232323-）</span>
<span class="cm"> * @return {integer} startPos 开始的下载点</span>
<span class="cm"> */</span>
<span class="nx">Transfer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_calStartPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Range</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">startPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">Range</span> <span class="o">!=</span> <span class="s1">'undefined'</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">startPosMatch</span> <span class="o">=</span> <span class="sr">/^bytes=([0-9]+)-$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">Range</span><span class="p">);</span>
        <span class="nx">startPos</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">startPosMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">startPos</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * @description 配置头文件</span>
<span class="cm"> * @param {object} Config 头文件配置信息（包含了下载的起始位置和文件的大小）</span>
<span class="cm"> */</span>
<span class="nx">Transfer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_configHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Config</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">startPos</span> <span class="o">=</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">startPos</span><span class="p">,</span> 
        <span class="nx">fileSize</span> <span class="o">=</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">fileSize</span><span class="p">,</span>
        <span class="nx">resp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resp</span><span class="p">;</span>
    <span class="c1">// 如果startPos为0，表示文件从0开始下载的，否则则表示是断点下载的。</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">startPos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">resp</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">'Accept-Range'</span><span class="p">,</span> <span class="s1">'bytes'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">resp</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">'Content-Range'</span><span class="p">,</span> <span class="s1">'bytes '</span> <span class="o">+</span> <span class="nx">startPos</span> <span class="o">+</span> <span class="s1">'-'</span> <span class="o">+</span> <span class="p">(</span><span class="nx">fileSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="nx">fileSize</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">resp</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">206</span><span class="p">,</span> <span class="s1">'Partial Content'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'Content-Type'</span> <span class="o">:</span> <span class="s1">'application/octet-stream'</span><span class="p">,</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>

<p>在nodejs中每一次http请求的头文件，已经被他封装在了http.ServerRequest的headers对象中，用node inspector的方式进行调试，就可以很清楚的看到了http.ServerRequest和http.ServerResponse对象的结构：<br><img src="http://ww2.sinaimg.cn/mw1024/6bf9eebbjw1ea0ztnpu7zj208u0avjs4.jpg" alt="截图" style="max-width:100%;"><br>
剩下来要做的，就是从断开的位置继续读取文件，并将其返回给客户端，可以用nodejs提供的ReadStream来实现：</p>

<div class="highlight highlight-javascript"><pre><span class="cm">/**</span>
<span class="cm"> * @description 初始化配置信息</span>
<span class="cm"> * @param {string} filePath</span>
<span class="cm"> * @param {function} down 下载开始的回调函数</span>
<span class="cm"> */</span>
<span class="nx">Transfer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">down</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
            <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>

        <span class="nx">config</span><span class="p">.</span><span class="nx">fileSize</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
        <span class="nx">config</span><span class="p">.</span><span class="nx">startPos</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_calStartPosition</span><span class="p">(</span><span class="nx">range</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="nx">config</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_configHeader</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
        <span class="nx">down</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * @description 生成大文件文档流，并发送</span>
<span class="cm"> * @param {string} filePath 文件地址</span>
<span class="cm"> */</span>
<span class="nx">Transfer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">Download</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">exist</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">exist</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">_init</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">config</span>
                    <span class="nx">resp</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">resp</span><span class="p">;</span>
                <span class="nx">fReadStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">encoding</span> <span class="o">:</span> <span class="s1">'binary'</span><span class="p">,</span>
                    <span class="nx">bufferSize</span> <span class="o">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
                    <span class="nx">start</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">startPos</span><span class="p">,</span>
                    <span class="nx">end</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">fileSize</span>
                <span class="p">});</span>
                <span class="nx">fReadStream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">resp</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="s1">'binary'</span><span class="p">);</span>
                <span class="p">});</span>
                <span class="nx">fReadStream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">resp</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'文件不存在！'</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>

<p>最终的可以用如下代码进行测试</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">)</span>
<span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">)</span>
<span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">transfer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Transfer</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">resp</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="s1">'/Users/xukai/Downloads/love.rmvb'</span><span class="p">;</span>
    <span class="nx">transfer</span><span class="p">.</span><span class="nx">Download</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="s1">'8000'</span><span class="p">);</span>
</pre></div>

<p>转载请注明出处<br><a href="http://botobe.net">botobe.net</a><br><a href="https://github.com/EchoFUN/melodycoder/issues/5">本文Github地址</a></p>

<p>按照惯例<br>
2012.3.10，情况一般。<br>
Merci !</p>