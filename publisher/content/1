												
	<p><a href="http://baike.baidu.com/view/25258.htm">Session</a>是神马？<br>
百度百科（百度最有价值的产品）上的解释是<br>
“在计算机专业术语中，session是指一个终端用户与交互系统进行通信的时间间隔，通常指从注册进入系统到注销退出系统之间所经过的时间以及如果需要的话，可能还有一定的操作空间。”<br>
通俗的讲，就是服务器端一段记录当前访问用户的空间。客户端的则是cookie，因为http协议无状态的特性，所以session的存在则必须依托于cookie。<br>
前段时间打算搞个NodeJS的简单框架来支持WALNUT的后台的。突然发现NodeJS神马的，连个session也没有，提供给一次请求的参数就是http. ServerResponse和http.ClientRequest实例化出来的对象。充满幻想的我顿时内牛满面 … …<br>
只好自己动手丰衣足食了。<br>
服务器端必须在客户端使用cookie，可以在返回的头文件中设置，使用http.ServerResponse类中的：</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">response.<span style="color: #660066;">setHeader</span><span style="color: #009900;">(</span><span style="color: #3366CC;">'Set-Cookie'</span><span style="color: #339933;">,</span> <span style="color: #009900;">[</span><span style="color: #3366CC;">'SID='</span> <span style="color: #339933;">+</span> sID<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></div></div>

<p>再通过每次获得客户端传来的cookie的，取出存放在服务器端对应session的方式，则可以很简单的模拟出session的效果。<br>
如果不存在则新建一个session，代码如下所示：</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #003366; font-weight: bold;">var</span> parse <span style="color: #339933;">=</span> require<span style="color: #009900;">(</span><span style="color: #3366CC;">'querystring'</span><span style="color: #009900;">)</span>.<span style="color: #660066;">parse</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #006600; font-style: italic;">/**
 * @description 设置session过期时间
 */</span>
<span style="color: #003366; font-weight: bold;">var</span> EXPIRE_TIME <span style="color: #339933;">=</span> <span style="color: #CC0000;">3</span> <span style="color: #339933;">*</span> <span style="color: #CC0000;">60</span> <span style="color: #339933;">*</span> <span style="color: #CC0000;">1000</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #006600; font-style: italic;">/**
 * @description 存放服务器端所有session
 */</span>
<span style="color: #003366; font-weight: bold;">var</span> _sessions <span style="color: #339933;">=</span> <span style="color: #009900;">{</span><span style="color: #009900;">}</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #003366; font-weight: bold;">function</span> genSID<span style="color: #009900;">(</span>pre<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	pre <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>pre<span style="color: #009900;">)</span><span style="color: #339933;">?</span>pre <span style="color: #339933;">:</span> <span style="color: #3366CC;">'SESSION'</span><span style="color: #339933;">;</span>
	<span style="color: #003366; font-weight: bold;">var</span> time <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">new</span> Date<span style="color: #009900;">(</span><span style="color: #009900;">)</span>.<span style="color: #660066;">getTime</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #3366CC;">''</span><span style="color: #339933;">;</span>
    <span style="color: #003366; font-weight: bold;">var</span> id <span style="color: #339933;">=</span> pre <span style="color: #339933;">+</span> <span style="color: #3366CC;">'_'</span> <span style="color: #339933;">+</span> <span style="color: #009900;">(</span>time<span style="color: #009900;">)</span>.<span style="color: #660066;">substring</span><span style="color: #009900;">(</span>time.<span style="color: #660066;">length</span> <span style="color: #339933;">-</span> <span style="color: #CC0000;">6</span><span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #3366CC;">'_'</span> <span style="color: #339933;">+</span> <span style="color: #009900;">(</span>Math.<span style="color: #660066;">round</span><span style="color: #009900;">(</span>Math.<span style="color: #660066;">random</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #339933;">*</span> <span style="color: #CC0000;">1000</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #000066; font-weight: bold;">return</span> id<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #006600; font-style: italic;">/**
 * @description 定时清理过期的session
 */</span>
setInterval<span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">{</span>
	<span style="color: #000066; font-weight: bold;">for</span> <span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">var</span> id <span style="color: #000066; font-weight: bold;">in</span> _sessions<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	    <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>_sessions.<span style="color: #660066;">hasOwnProperty</span><span style="color: #009900;">(</span>id<span style="color: #009900;">)</span><span style="color: #009900;">)</span> 
	    	<span style="color: #000066; font-weight: bold;">continue</span><span style="color: #339933;">;</span>
		<span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">new</span> Date<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #339933;">-</span> _sessions<span style="color: #009900;">[</span>id<span style="color: #009900;">]</span>.<span style="color: #660066;">timestamp</span> <span style="color: #339933;">&gt;</span> EXPIRE_TIME<span style="color: #009900;">)</span>
			<span style="color: #000066; font-weight: bold;">delete</span> _sessions<span style="color: #009900;">[</span>id<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">1000</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #003366; font-weight: bold;">var</span> createSession <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span>sID<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	<span style="color: #003366; font-weight: bold;">var</span> session <span style="color: #339933;">=</span> <span style="color: #009900;">{</span>
		SID<span style="color: #339933;">:</span> sID<span style="color: #339933;">,</span>
		timestamp<span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">new</span> Date<span style="color: #009900;">(</span><span style="color: #009900;">)</span>
	<span style="color: #009900;">}</span>
	<span style="color: #000066; font-weight: bold;">return</span> session<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #006600; font-style: italic;">/**
 * @description 维护了对session的引用，可进行增删查改操作
 * @param {string} sID 当前用户的session ID
 * @param {object} _sessions
 */</span>
<span style="color: #003366; font-weight: bold;">var</span> context <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span>_sessions<span style="color: #339933;">,</span> sID<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">poke</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		_sessions<span style="color: #009900;">[</span>sID<span style="color: #009900;">]</span>.<span style="color: #660066;">timestamp</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">new</span> Date<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
	<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">destory</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #000066; font-weight: bold;">delete</span> _sessions<span style="color: #009900;">[</span>sID<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
	<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">del</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span>key<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">poke</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #000066; font-weight: bold;">delete</span> _sessions<span style="color: #009900;">[</span>sID<span style="color: #009900;">]</span><span style="color: #009900;">[</span>key<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">set</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span>key<span style="color: #339933;">,</span> value<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">poke</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		_sessions<span style="color: #009900;">[</span>sID<span style="color: #009900;">]</span><span style="color: #009900;">[</span>key<span style="color: #009900;">]</span> <span style="color: #339933;">=</span> value<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
	<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">get</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span>key<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">poke</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #000066; font-weight: bold;">return</span> _sessions<span style="color: #009900;">[</span>sID<span style="color: #009900;">]</span><span style="color: #009900;">[</span>key<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #006600; font-style: italic;">/**
 * @description 开始session
 * @param {object} request 
 * @param {object} response
 * @param {function} process 回调函数
 */</span>
exports.<span style="color: #660066;">startSession</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span>request<span style="color: #339933;">,</span> response<span style="color: #339933;">,</span> process<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	<span style="color: #003366; font-weight: bold;">var</span> cookies <span style="color: #339933;">=</span> parse<span style="color: #009900;">(</span>request.<span style="color: #660066;">headers</span>.<span style="color: #660066;">cookie</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">'; '</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #003366; font-weight: bold;">var</span> sID<span style="color: #339933;">;</span>
	<span style="color: #000066; font-weight: bold;">for</span> <span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">var</span> i <span style="color: #000066; font-weight: bold;">in</span> cookies<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">==</span> <span style="color: #3366CC;">'SID'</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			sID <span style="color: #339933;">=</span> cookies<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
			<span style="color: #000066; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
	<span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>sID <span style="color: #339933;">||</span> <span style="color: #000066; font-weight: bold;">typeof</span> _sessions<span style="color: #009900;">[</span>sID<span style="color: #009900;">]</span> <span style="color: #339933;">==</span> <span style="color: #3366CC;">'undefined'</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #003366; font-weight: bold;">var</span> sID <span style="color: #339933;">=</span> genSID<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		_sessions<span style="color: #009900;">[</span>sID<span style="color: #009900;">]</span> <span style="color: #339933;">=</span> createSession<span style="color: #009900;">(</span>sID<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	response.<span style="color: #660066;">setHeader</span><span style="color: #009900;">(</span><span style="color: #3366CC;">'Set-Cookie'</span><span style="color: #339933;">,</span> <span style="color: #009900;">[</span><span style="color: #3366CC;">'SID='</span> <span style="color: #339933;">+</span> sID<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	process.<span style="color: #660066;">call</span><span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">new</span> context<span style="color: #009900;">(</span>_sessions<span style="color: #339933;">,</span> sID<span style="color: #009900;">)</span><span style="color: #339933;">,</span> request<span style="color: #339933;">,</span> response<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></div></div>

<p>测试代码，主程序：</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #003366; font-weight: bold;">var</span> http <span style="color: #339933;">=</span> require<span style="color: #009900;">(</span><span style="color: #3366CC;">'http'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #003366; font-weight: bold;">var</span> sessionFactory <span style="color: #339933;">=</span> require<span style="color: #009900;">(</span><span style="color: #3366CC;">'./session'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #003366; font-weight: bold;">var</span> server <span style="color: #339933;">=</span> http.<span style="color: #660066;">createServer</span><span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span>request<span style="color: #339933;">,</span> response<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	sessionFactory.<span style="color: #660066;">startSession</span><span style="color: #009900;">(</span>request<span style="color: #339933;">,</span> response<span style="color: #339933;">,</span> handler<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #003366; font-weight: bold;">var</span> handler <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span>request<span style="color: #339933;">,</span> response<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	<span style="color: #003366; font-weight: bold;">var</span> session <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">this</span><span style="color: #339933;">;</span>
	session.<span style="color: #660066;">set</span><span style="color: #009900;">(</span><span style="color: #3366CC;">'banana'</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">'你个巴啦~'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	response.<span style="color: #660066;">end</span><span style="color: #009900;">(</span>session.<span style="color: #660066;">get</span><span style="color: #009900;">(</span><span style="color: #3366CC;">'banana'</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
server.<span style="color: #660066;">listen</span><span style="color: #009900;">(</span><span style="color: #3366CC;">'80'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></div></div>

<p>OK.<br>
写在最后：<br>
NodeJS，语言既是服务器，服务器既是语言的，这种方式很特别。想当初，nginx，apache的设计，就是为了把应用服务器和应用给分开来。这样的设计究竟是进步了还是倒退了，嗯~ 不好说。<br>
总而言之，其实也无所谓啦！存在即合理，<strong>适合的就是最好的。</strong><br>
2011.12.6，一切安好。<br>
Merci !</p>
	
